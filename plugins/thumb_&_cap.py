from pyrogram import Client, filters
from pyrogram.types import Message, InlineKeyboardButton, InlineKeyboardMarkup, CallbackQuery
from pyrogram.enums import ChatAction, ChatMemberStatus
from pyrogram.errors import UserNotParticipant
from datetime import datetime, timedelta
from helper.database import codeflixbots
from config import Config
from functools import wraps

chat_data_cache = {}
ADMIN_URL = Config.ADMIN_URL
FSUB_PIC = Config.FSUB_PIC
BOT_USERNAME = Config.BOT_USERNAME
OWNER_ID = Config.OWNER_ID
FSUB_LINK_EXPIRY = 10

def check_ban(func):
    @wraps(func)
    async def wrapper(client, message, *args, **kwargs):
        user_id = message.from_user.id
        user = await codeflixbots.col.find_one({"_id": user_id})
        if user and user.get("ban_status", {}).get("is_banned", False):
            keyboard = InlineKeyboardMarkup(
                [[InlineKeyboardButton("C·¥è…¥·¥õ·¥Ä·¥Ñ·¥õ  ú·¥á Ä·¥á...!!", url=ADMIN_URL)]]
            )
            return await message.reply_text(
                "W·¥õ“ì  è·¥è·¥ú ·¥Ä Ä·¥á  ô·¥Ä…¥…¥·¥á·¥Ö “ì Ä·¥è·¥ç ·¥ús…™…¥…¢ ·¥ç·¥á  ô è ·¥è·¥ú Ä ·¥Ä·¥Ö·¥ç…™…¥/·¥è·¥°…¥·¥á Ä . I“ì  è·¥è·¥ú ·¥õ ú…™…¥·¥ãs …™·¥õ's ·¥ç…™s·¥õ·¥Ä·¥ã·¥á ·¥Ñ ü…™·¥Ñ·¥ã ·¥è…¥ **·¥Ñ·¥è…¥·¥õ·¥Ä·¥Ñ·¥õ  ú·¥á Ä·¥á...!!**",
                reply_markup=keyboard
            )
        return await func(client, message, *args, **kwargs)
    return wrapper
	
def check_fsub(func):
    @wraps(func)
    async def wrapper(client, message, *args, **kwargs):
        user_id = message.from_user.id
        print(f"DEBUG: check_fsub decorator called for user {user_id}")

        async def is_sub(client, user_id, channel_id):
            try:
                member = await client.get_chat_member(channel_id, user_id)
                status = member.status
                return status in {
                    ChatMemberStatus.OWNER,
                    ChatMemberStatus.ADMINISTRATOR,
                    ChatMemberStatus.MEMBER
                }
            except UserNotParticipant:
                mode = await codeflixbots.get_channel_mode(channel_id)
                if mode == "on":
                    exists = await codeflixbots.req_user_exist(channel_id, user_id)
                    return exists
                return False
            except Exception as e:
                print(f"[!] Error in is_sub(): {e}")
                return False

        async def is_subscribed(client, user_id):
            channel_ids = await codeflixbots.show_channels()
            if not channel_ids:
                return True
            if user_id == OWNER_ID:
                return True
            for cid in channel_ids:
                if not await is_sub(client, user_id, cid):
                    mode = await codeflixbots.get_channel_mode(cid)
                    if mode == "on":
                        await asyncio.sleep(2)
                        if await is_sub(client, user_id, cid):
                            continue
                    return False
            return True

        try:
            is_sub_status = await is_subscribed(client, user_id)
            print(f"DEBUG: User {user_id} subscribed status: {is_sub_status}")

            if not is_sub_status:
                print(f"DEBUG: User {user_id} is not subscribed, calling not_joined.")
                return await not_joined(client, message)

            print(f"DEBUG: User {user_id} is subscribed, proceeding with function call.")
            return await func(client, message, *args, **kwargs)

        except Exception as e:
            print(f"FATAL ERROR in check_fsub: {e}")
            await message.reply_text(f"An unexpected error occurred: {e}. Please contact the developer.")
            return

    return wrapper

async def check_admin(filter, client, update):
    try:
        user_id = update.from_user.id
        return any([user_id == OWNER_ID, await codeflixbots.admin_exist(user_id)])
    except Exception as e:
        print(f"! Exception in check_admin: {e}")
        return False

async def not_joined(client: Client, message: Message):
    print(f"DEBUG: not_joined function called for user {message.from_user.id}")
    temp = await message.reply("<b><i>·¥°·¥Ä…™·¥õ ·¥Ä s·¥á·¥Ñ..</i></b>")

    user_id = message.from_user.id
    buttons = []
    count = 0

    try:
        all_channels = await codeflixbots.show_channels()
        for chat_id in all_channels:
            await message.reply_chat_action(ChatAction.TYPING)

            try:
                member = await client.get_chat_member(chat_id, user_id)
                is_member = member.status in {
                    ChatMemberStatus.OWNER,
                    ChatMemberStatus.ADMINISTRATOR,
                    ChatMemberStatus.MEMBER
                }
            except UserNotParticipant:
                is_member = False
            except Exception as e:
                is_member = False
                print(f"[!] Error checking member in not_joined: {e}")

            if not is_member:
                try:
                    if chat_id in chat_data_cache:
                        data = chat_data_cache[chat_id]
                    else:
                        data = await client.get_chat(chat_id)
                        chat_data_cache[chat_id] = data
                    name = data.title

                    mode = await codeflixbots.get_channel_mode(chat_id)
                    if mode == "on" and not data.username:
                        invite = await client.create_chat_invite_link(
                            chat_id=chat_id,
                            creates_join_request=True,
                            expire_date=datetime.utcnow() + timedelta(seconds=FSUB_LINK_EXPIRY) if FSUB_LINK_EXPIRY else None
                        )
                        link = invite.invite_link
                    else:
                        if data.username:
                            link = f"https://t.me/{data.username}"
                        else:
                            invite = await client.create_chat_invite_link(
                                chat_id=chat_id,
                                expire_date=datetime.utcnow() + timedelta(seconds=FSUB_LINK_EXPIRY) if FSUB_LINK_EXPIRY else None
                            )
                            link = invite.invite_link

                    buttons.append([InlineKeyboardButton(text=name, url=link)])
                    count += 1
                    await temp.edit(f"<b>{'! ' * count}</b>")
                except Exception as e:
                    print(f"Error with chat {chat_id}: {e}")
                    return await temp.edit(
                        f"<b><i>! E Ä Ä·¥è Ä, C·¥è…¥·¥õ·¥Ä·¥Ñ·¥õ ·¥Ö·¥á·¥†·¥á ü·¥è·¥ò·¥á Ä ·¥õ·¥è s·¥è ü·¥†·¥á ·¥õ ú·¥á …™ss·¥ú·¥ás @seishiro_obito</i></b>\n"
                        f"<blockquote expandable><b>R·¥á·¥Äs·¥è…¥:</b> {e}</blockquote>"
                    )

        try:
            buttons.append([
                InlineKeyboardButton(
                    text='‚Ä¢ J·¥è…™…¥·¥á·¥Ö ‚Ä¢',
                    url=f"https://t.me/{Config.BOT_USERNAME}?start=true"
                )
            ])
        except IndexError:
            pass

        text = "<b>Y·¥è·¥ú B·¥Ä·¥ã·¥ã·¥Ä·¥Ä...!! \n\n<blockquote>J·¥è…™…¥ ·¥ç è ·¥Ñ ú·¥Ä…¥…¥·¥á ü ·¥õ·¥è ·¥ús·¥á ·¥ç è ·¥è·¥õ ú·¥á Ä·¥°…™s·¥á Y·¥è·¥ú ·¥Ä Ä·¥á …™…¥  ô…™…¢ s ú…™·¥õ...!!</blockquote></b>"
        await temp.delete()

        print(f"DEBUG: Sending final reply photo to user {user_id}")
        await message.reply_photo(
            photo=FSUB_PIC,
            caption=text,
            reply_markup=InlineKeyboardMarkup(buttons),
        )

    except Exception as e:
        print(f"Final Error: {e}")
        await temp.edit(
            f"<b><i>! E Ä Ä·¥è Ä, C·¥è…¥·¥õ·¥Ä·¥Ñ·¥õ ·¥Ö·¥á·¥†·¥á ü·¥è·¥ò·¥á Ä ·¥õ·¥è s·¥è ü·¥†·¥á ·¥õ ú·¥á …™ss·¥ú·¥ás @seishiro_obito</i></b>\n"
            f"<blockquote expandable><b>R·¥á·¥Äs·¥è…¥:</b> {e}</blockquote>"
        )

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

@Client.on_message(filters.private & filters.command('set_caption'))
@check_ban
@check_fsub
async def add_caption(client, message):
    if len(message.command) == 1:
       return await message.reply_text("**Give The Caption\n\nExample :- `/set_caption üìïName ‚û† : {filename} \n\nüîó Size ‚û† : {filesize} \n\n‚è∞ Duration ‚û† : {duration}`**")
    caption = message.text.split(" ", 1)[1]
    await codeflixbots.set_caption(message.from_user.id, caption=caption)
    await message.reply_text("**Your Caption Successfully Added ‚úÖ**")
   
@Client.on_message(filters.private & filters.command('del_caption'))
@check_ban
@check_fsub
async def delete_caption(client, message):
    caption = await codeflixbots.get_caption(message.from_user.id)  
    if not caption:
       return await message.reply_text("**You Don't Have Any Caption ‚ùå**")
    await codeflixbots.set_caption(message.from_user.id, caption=None)
    await message.reply_text("**Your Caption Successfully Deleted üóëÔ∏è**")
                                       
@Client.on_message(filters.private & filters.command(['see_caption', 'view_caption']))
@check_ban
@check_fsub
async def see_caption(client, message):
    caption = await codeflixbots.get_caption(message.from_user.id)  
    if caption:
       await message.reply_text(f"**Your Caption :**\n\n`{caption}`")
    else:
       await message.reply_text("**You Don't Have Any Caption ‚ùå**")


@Client.on_message(filters.private & filters.command(['view_thumb', 'viewthumb']))
@check_ban
@check_fsub
async def viewthumb(client, message):    
    thumb = await codeflixbots.get_thumbnail(message.from_user.id)
    if thumb:
       await client.send_photo(chat_id=message.chat.id, photo=thumb)
    else:
        await message.reply_text("**You Don't Have Any Thumbnail ‚ùå**") 
		
@Client.on_message(filters.private & filters.command(['del_thumb', 'delthumb']))
@check_ban
@check_fsub
async def removethumb(client, message):
    await codeflixbots.set_thumbnail(message.from_user.id, file_id=None)
    await message.reply_text("**Thumbnail Deleted Successfully üóëÔ∏è**")
	
@Client.on_message(filters.private & filters.photo)
@check_ban
@check_fsub
async def addthumbs(client, message):
    mkn = await message.reply_text("Please Wait ...")
    await codeflixbots.set_thumbnail(message.from_user.id, file_id=message.photo.file_id)                
    await mkn.edit("**Thumbnail Saved Successfully ‚úÖÔ∏è**")
